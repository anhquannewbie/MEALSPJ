{% extends "admin/change_form.html" %}
{% load i18n admin_urls static admin_modify %}

{% block extrahead %}{{ block.super }}
<script type="text/javascript" src="{% url 'admin:jsi18n' %}"></script>

<style>
/* Enhanced date input styling */
.enhanced-date-container {
    position: relative !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 10px !important;
}

#id_date {
    padding: 12px 45px 12px 15px !important;
    border: 2px solid #ddd !important;
    border-radius: 8px !important;
    font-size: 14px !important;
    transition: all 0.3s ease !important;
    background: white !important;
    min-width: 200px !important;
    cursor: pointer !important;
    position: relative !important;
}

#id_date:focus, #id_date:hover {
    border-color: #007cba !important;
    box-shadow: 0 0 0 3px rgba(0, 124, 186, 0.1) !important;
    outline: none !important;
}

/* Custom calendar icon overlay */
.calendar-icon-overlay {
    position: absolute !important;
    right: 10px !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    width: 25px !important;
    height: 25px !important;
    background: linear-gradient(135deg, #007cba 0%, #005a87 100%) !important;
    border-radius: 4px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    color: white !important;
    font-size: 12px !important;
    pointer-events: none !important;
    z-index: 10 !important;
}

/* Custom Today button */
.custom-today-btn {
    background: linear-gradient(135deg, #28a745 0%, #20a039 100%) !important;
    color: white !important;
    border: none !important;
    padding: 12px 20px !important;
    border-radius: 8px !important;
    font-size: 13px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.3s ease !important;
    white-space: nowrap !important;
}

.custom-today-btn:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
}

/* Hide Django's default shortcuts */
.datetimeshortcuts {
    display: none !important;
}

/* Dark mode support for date input */
html[data-theme="dark"] #id_date {
    background: #1e293b !important;
    color: #f1f5f9 !important;
    border-color: #334155 !important;
}

html[data-theme="dark"] #id_date:focus {
    border-color: #007cba !important;
    box-shadow: 0 0 0 3px rgba(0, 124, 186, 0.2) !important;
    background: #1e293b !important;
    color: #f1f5f9 !important;
}

html[data-theme="dark"] #id_date::-webkit-calendar-picker-indicator {
    filter: invert(1) !important;
}

html[data-theme="dark"] #id_date::-moz-calendar-picker-indicator {
    filter: invert(1) !important;
}

/* Ensure text is visible in all themes */
#id_date {
    color: #1e293b !important;
}

html[data-theme="dark"] #id_date {
    color: #f1f5f9 !important;
}

/* Make the entire input clickable */
.date-input-wrapper {
    position: relative !important;
    cursor: pointer !important;
}

/* Ensure calendar picker covers full area */
#id_date::-webkit-calendar-picker-indicator {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    opacity: 0 !important;
    cursor: pointer !important;
}

/* Firefox calendar button */
#id_date::-moz-calendar-picker-indicator {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    opacity: 0 !important;
    cursor: pointer !important;
}

/* Instruction text */
.date-instruction {
    font-size: 11px !important;
    color: #666 !important;
    margin-top: 4px !important;
    font-style: italic !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.querySelector('#id_date');
    if (!dateInput) return;
    
    console.log('🎯 Setting up auto-close HTML5 date picker...');
    
    // Remove Django's shortcuts first
    const shortcuts = document.querySelectorAll('.datetimeshortcuts');
    shortcuts.forEach(s => s.remove());
    
    // Change input type to date for native picker
    dateInput.type = 'date';
    
    // Track calendar state
    let isCalendarOpen = false;
    let calendarCloseTimer = null;
    
    // Wrap input in container
    const container = document.createElement('div');
    container.className = 'enhanced-date-container';
    
    // Create wrapper for clickable area
    const inputWrapper = document.createElement('div');
    inputWrapper.className = 'date-input-wrapper';
    
    dateInput.parentNode.insertBefore(container, dateInput);
    container.appendChild(inputWrapper);
    inputWrapper.appendChild(dateInput);
    
    // Add calendar icon overlay
    const iconOverlay = document.createElement('div');
    iconOverlay.className = 'calendar-icon-overlay';
    iconOverlay.innerHTML = '📅';
    inputWrapper.appendChild(iconOverlay);
    
    // Add instruction text
    const instruction = document.createElement('div');
    instruction.className = 'date-instruction';
    instruction.textContent = 'Click vào field để mở lịch • Esc để đóng lịch';
    inputWrapper.appendChild(instruction);
    
    // Add custom Today button
    const todayBtn = document.createElement('button');
    todayBtn.textContent = '📅 Hôm nay';
    todayBtn.className = 'custom-today-btn';
    todayBtn.type = 'button';
    
    // Today button functionality
    todayBtn.addEventListener('click', function() {
        const today = new Date();
        const formattedDate = today.getFullYear() + '-' + 
                            String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(today.getDate()).padStart(2, '0');
        dateInput.value = formattedDate;
        dateInput.dispatchEvent(new Event('change'));
        
        // Close calendar if open
        closeCalendar();
        
        // Visual feedback
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = '';
        }, 150);
        
        console.log('📅 Today set:', formattedDate);
    });
    
    container.appendChild(todayBtn);
    
    // Calendar management functions
    function openCalendar() {
        console.log('🗓️ Opening calendar...');
        isCalendarOpen = true;
        
        // Clear any pending close timer
        if (calendarCloseTimer) {
            clearTimeout(calendarCloseTimer);
            calendarCloseTimer = null;
        }
        
        // Focus and show picker
        dateInput.focus();
        
        // Try showPicker if available (Chrome 99+)
        if (dateInput.showPicker && typeof dateInput.showPicker === 'function') {
            try {
                dateInput.showPicker();
                console.log('✅ Calendar opened via showPicker()');
            } catch (e) {
                console.log('⚠️ showPicker() not available');
                // Fallback to click
                setTimeout(() => dateInput.click(), 10);
            }
        } else {
            // Fallback to click
            setTimeout(() => dateInput.click(), 10);
        }
        
        // Visual feedback
        dateInput.style.borderColor = '#007cba';
        iconOverlay.style.transform = 'translateY(-50%) scale(1.1)';
    }
    
    function closeCalendar() {
        console.log('❌ Closing calendar...');
        isCalendarOpen = false;
        
        // Blur the input to close calendar
        dateInput.blur();
        
        // Additional methods to ensure closure
        if (document.activeElement === dateInput) {
            document.body.focus();
        }
        
        // Reset visual state
        dateInput.style.borderColor = '#ddd';
        iconOverlay.style.transform = 'translateY(-50%)';
        
        // For browsers that support it, try to close programmatically
        if (dateInput.showPicker) {
            // Some browsers may support closing via focus management
            setTimeout(() => {
                if (document.activeElement === dateInput) {
                    document.body.click();
                }
            }, 50);
        }
    }
    
    function scheduleClose() {
        // Schedule calendar close with a small delay
        calendarCloseTimer = setTimeout(() => {
            if (isCalendarOpen) {
                closeCalendar();
            }
        }, 100);
    }
    
    // Event listeners for opening calendar
    dateInput.addEventListener('click', function(e) {
        console.log('📅 Input clicked');
        if (!isCalendarOpen) {
            openCalendar();
        }
    });
    
    inputWrapper.addEventListener('click', function(e) {
        if (e.target !== dateInput && !isCalendarOpen) {
            console.log('📦 Wrapper clicked');
            openCalendar();
        }
    });
    
    // Track when calendar is opened
    dateInput.addEventListener('focus', function() {
        console.log('🎯 Input focused');
        if (!isCalendarOpen) {
            isCalendarOpen = true;
            iconOverlay.style.transform = 'translateY(-50%) scale(1.1)';
        }
        
        // Clear any pending close
        if (calendarCloseTimer) {
            clearTimeout(calendarCloseTimer);
            calendarCloseTimer = null;
        }
    });
    
    // Track when calendar might be closed
    dateInput.addEventListener('blur', function() {
        console.log('👋 Input blurred');
        scheduleClose();
    });
    
    // Handle change events (when user selects a date)
    dateInput.addEventListener('change', function() {
        console.log('📅 Date changed to:', this.value);
        
        // Close calendar after selection
        setTimeout(() => {
            closeCalendar();
        }, 100);
        
        // Brief highlight effect
        this.style.backgroundColor = '#e7f3ff';
        setTimeout(() => {
            this.style.backgroundColor = 'white';
        }, 300);
    });
    
    // Keyboard handling
    dateInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            console.log('⌨️ Escape pressed - closing calendar');
            e.preventDefault();
            closeCalendar();
        } else if (e.key === 'Enter' || e.key === ' ') {
            if (!isCalendarOpen) {
                console.log('⌨️ Enter/Space pressed - opening calendar');
                e.preventDefault();
                openCalendar();
            }
        }
    });
    
    // Global click handler to close calendar when clicking outside
    document.addEventListener('click', function(e) {
        if (isCalendarOpen && !container.contains(e.target)) {
            console.log('🌍 Clicked outside - scheduling calendar close');
            scheduleClose();
        }
    });
    
    // Prevent calendar from closing when clicking inside container
    container.addEventListener('click', function(e) {
        if (calendarCloseTimer) {
            console.log('🛡️ Click inside container - preventing close');
            clearTimeout(calendarCloseTimer);
            calendarCloseTimer = null;
        }
    });
    
    // Enhanced mouse interactions
    inputWrapper.addEventListener('mouseenter', function() {
        if (!isCalendarOpen) {
            dateInput.style.borderColor = '#007cba';
            iconOverlay.style.transform = 'translateY(-50%) scale(1.05)';
        }
    });
    
    inputWrapper.addEventListener('mouseleave', function() {
        if (!isCalendarOpen) {
            dateInput.style.borderColor = '#ddd';
            iconOverlay.style.transform = 'translateY(-50%)';
        }
    });
    
    console.log('✅ Auto-close date picker setup complete');
});
</script>
{% endblock %}